# Expense Tracker

A web application for tracking personal expenses by category.

## Overview

Users log expenses (amount, description, date, category). Admins manage categories. SuperAdmin manages user roles.
Built as a practical AI-assisted development exercise  90%+ of code generated by GitHub Copilot.

## Tech Stack

| Layer    | Technology                                              |
|----------|---------------------------------------------------------|
| Backend  | .NET 8 Web API, Onion Architecture, CQRS (MediatR)     |
| ORM      | Entity Framework Core 8, SQLite                         |
| Validation | FluentValidation 11                                   |
| Auth     | JWT Bearer, BCrypt                                      |
| Frontend | React 19, Vite, TypeScript                              |
| UI       | Ant Design 5, @ant-design/icons                        |
| Forms    | Formik, Yup                                             |
| Routing  | React Router DOM v7                                     |
| HTTP     | Axios                                                   |

## Backend Architecture

Four-project Onion Architecture with CQRS and Result pattern:

```
server/
  ExpenseTracker.sln
  shared/                          ← .editorconfig
  src/
    ExpenseTracker.Core            ← Entities, interfaces (no dependencies)
    ExpenseTracker.Logic           ← CQRS handlers (MediatR), DTOs, co-located validators, Result<T> pattern
    ExpenseTracker.Persistence     ← EF Core, repositories
    ExpenseTracker.Api             ← Thin controllers, auth services (JWT, BCrypt), composition root
  tests/
    ExpenseTracker.UnitTests       ← xUnit + Moq + FluentAssertions
```

Dependency flow: **Api → Persistence → Logic → Core**

Error handling uses the **Result pattern** — handlers return `Result` / `Result<T>` with `DomainError` instead of throwing exceptions. `ApiControllerBase.MapError()` converts errors to appropriate HTTP status codes + ProblemDetails.

## Running the App

**Backend** (port 5001):
```bash
cd server/src/ExpenseTracker.Api
dotnet run
```

**Frontend** (port 5173):
```bash
cd client/expense-tracker-ui
npm install
npm run dev
```

Swagger UI: http://localhost:5001/swagger

## Default SuperAdmin

A SuperAdmin user is seeded automatically via migration:

| Field    | Value            |
|----------|------------------|
| Email    | `admin@mail.ru`  |
| Password | `12345678`       |
| Role     | `SuperAdmin`     |

### Roles

| Role       | Permissions                                      |
|------------|--------------------------------------------------|
| SuperAdmin | Manage user roles, manage categories, all access |
| Admin      | Manage categories, own expenses                  |
| User       | Own expenses only                                |

---

## AI Tools Used

| Tool | Purpose |
|------|---------|
| GitHub Copilot (Agent mode, Claude Sonnet 4.6) | All code generation, architecture, prompt files |
| `.github/copilot-instructions.md` | Shared project context auto-loaded by Copilot |
| `.github/prompts/backend-dev.prompt.md` | Backend agent instructions (load with `#backend-dev`) |
| `.github/prompts/ui-dev.prompt.md` | UI agent instructions (load with `#ui-dev`) |
| `.github/prompts/test-dev.prompt.md` | Test agent instructions (load with `#test-dev`) |
| `.github/prompts/backend-test.prompt.md` | Backend test agent instructions (load with `#backend-test`) |


## Agent Workflow

Two-agent model in a single Copilot Chat session:
- **Backend Developer** (`#backend-dev`)  implements .NET files one by one
- **UI Developer** (`#ui-dev`)  implements React components one by one

---

## Prompt History

### Step 1  Project scaffold & NuGet packages
**Agent:** GitHub Copilot
**Prompt:**
> Describe the backend skeleton structure needed for Expense Tracker: folders, stub files, packages to install. Do not generate code yet  only the plan.

**Result:** Full plan with file structure, NuGet package list, port configuration.
**Accepted/Changed:** Accepted as-is. Served as the execution plan for the next step.

---

### Step 2  Backend skeleton creation
**Agent:** GitHub Copilot
**Prompt:**
> Execute the skeleton plan: install NuGet packages, create stub files (namespace + class only), update port to 5001.

**Result:** 4 NuGet packages installed (EF Core SQLite, EF Core Design, JwtBearer, BCrypt), 7 stub files created across Models/, Data/, Controllers/, port updated in launchSettings.json. Build succeeded.
**Accepted/Changed:** NuGet version conflict resolved  manually specified `--version 8.0.*` because NuGet defaulted to .NET 10 versions incompatible with net8.0 target.

---

### Step 3  Instruction files for agents
**Agent:** GitHub Copilot
**Prompt:**
> Create instruction files for the agent workflow: shared copilot-instructions.md (always active), backend-dev.prompt.md, ui-dev.prompt.md.

**Result:** Files created. `copilot-instructions.md` contains shared models + API contract. Each `.prompt.md` contains role-specific tech details, file status table, and implementation specs.
**Accepted/Changed:** Accepted as-is.

---

### Step 4 — Frontend skeleton
**Agent:** UI Developer
**Prompt:**
> Scaffold Vite + React + TS, install react-router-dom + axios, create stub files for all layouts/pages/components, wire full routing in App.tsx.

**Result:** Project scaffolded, 13 stub files created, routing wired, `npm run dev` starts on port 5173.
**Accepted/Changed:** Accepted as-is.

---

### Step 5 — Backend models
**Agent:** Backend Developer
**Prompt:**
> Implement `Models/User.cs`, `Models/Category.cs`, `Models/Expense.cs`. Use the Data Models table from `copilot-instructions.md`. Add navigation properties `User` and `Category` to `Expense`.

**Result:** Three model classes with all properties, FK relations, and navigation properties.
**Accepted/Changed:** Accepted as-is.

---

### Step 6 — AppDbContext
**Agent:** Backend Developer
**Prompt:**
> Implement `Data/AppDbContext.cs`. DbSets for User, Category, Expense. Seed default categories in `OnModelCreating`.

**Result:** Context with 3 DbSets, fluent config (unique email, decimal precision, FK cascades), 8 seeded categories.
**Accepted/Changed:** Agent seeded 8 categories instead of 6 — accepted, extra categories add value.

---

### Step 7 — appsettings.json + Program.cs
**Agent:** Backend Developer
**Prompt:**
> Configure `appsettings.json` and `Program.cs` so the API starts on port 5001 with authentication, database, CORS, and Swagger.

**Result:** SQLite connection, JWT config, CORS for `http://localhost:5173`, Swagger with Bearer support, auto-migration on startup.
**Accepted/Changed:** Accepted as-is.

---

### Step 8 — AuthController
**Agent:** Backend Developer
**Prompt:**
> Implement register and login endpoints. Return a JWT token on success.

**Result:** `POST /api/auth/register` and `POST /api/auth/login` with BCrypt hashing, role assignment, and 7-day JWT.
**Accepted/Changed:** Accepted as-is.

---

### Step 9 — ExpensesController + CategoriesController
**Agent:** Backend Developer
**Prompt:**
> Implement expenses CRUD (user sees only their own). Implement categories endpoints — anyone reads, only Admins write.

**Result:** Full CRUD for expenses scoped by userId from JWT. Categories: public GET, Admin/SuperAdmin POST/PUT/DELETE.
**Accepted/Changed:** Accepted as-is.

---

### Step 10 — Auth flow (UI)
**Agent:** UI Developer
**Prompt:**
> Implement the full authentication flow: ProtectedRoute, AdminRoute, LoginPage, RegisterPage, AuthLayout.

**Result:** Login/register forms with API calls, token persistence, redirects, error handling. Route guards redirect unauthenticated users to `/login` and non-admins away from admin area.
**Accepted/Changed:** Accepted as-is.

---

### Step 11 — Expenses UI
**Agent:** UI Developer
**Prompt:**
> Implement DashboardPage (expense list, total, category filter, delete, links to add/edit) and ExpenseFormPage (add/edit form with amount, description, date, category select).

**Result:** Dashboard with full expense table, color-coded category badges, total sum, filter, delete confirmation. ExpenseFormPage detects add vs edit mode from URL param.
**Accepted/Changed:** Accepted as-is.

---

### Step 12 — Navigation + Admin UI
**Agent:** UI Developer
**Prompt:**
> Implement MainLayout (navbar + logout + Admin link for admins), AdminLayout (sidebar), CategoriesPage (table + delete + nav), CategoryFormPage (add/edit with color picker).

**Result:** Full navigation with role-based Admin link, logout, admin category management with color swatches and color picker.
**Accepted/Changed:** Accepted as-is.

---

### Step 13 — Backend architecture refactor (Onion + CQRS)
**Agent:** Backend Developer (GitHub Copilot, Claude Opus 4.6)
**Prompt:**
> Analyse the BE part of the project and suggest improvements according to best programming practices. Full refactor with Onion Architecture, DI, CQRS (MediatR), FluentValidation, repository pattern. Update all documentation.

**Result:** Restructured from single-project to 4-project Onion Architecture (Domain, Application, Infrastructure, Api). Implemented CQRS with MediatR (16 command/query handlers), FluentValidation pipeline behavior, repository + UoW pattern, domain exceptions with ProblemDetails error responses, health checks. All API endpoints preserved — zero breaking changes for the frontend.
**Accepted/Changed:** Accepted as-is. All endpoints verified: auth, CRUD, validation (422), authorization (403), conflict detection (409), health check.

---

### Step 14 — Result pattern, project renaming, co-located validators
**Agent:** Backend Developer (GitHub Copilot, Claude Opus 4.6)
**Prompt:**
> Remove domain exceptions, use Result&lt;T&gt; pattern instead. Co-locate validators with their commands/queries. Rename projects: Domain→Core, Application→Logic, Infrastructure→Persistence. Move auth services (JWT, BCrypt) from Infrastructure to Api.

**Result:** Replaced 5 domain exception classes with Result/Result&lt;T&gt;/DomainError pattern. Renamed all projects (Core, Logic, Persistence, Api). Validators co-located in same folder as commands/queries. Auth services moved to Api/Auth/. Added ApiControllerBase with MapError() helper. GlobalExceptionHandler simplified to only handle ValidationException + unhandled errors.
**Accepted/Changed:** Accepted as-is. All endpoints verified: register (201), login (200), duplicate email (409), bad password (401), expense CRUD (201/204/404), validation (422), categories (200/201/204).

---

### Step 15 — SuperAdmin role & user management
**Agent:** Backend Developer (GitHub Copilot, Claude Opus 4.6)
**Prompt:**
> Create a SuperAdmin user seeded via migration (admin@mail.ru / 12345678). Add three roles: SuperAdmin, Admin, User. SuperAdmin can assign/revoke Admin role. Admins manage categories. Add Users API (GET /api/users, PUT /api/users/{id}/role) for SuperAdmin only. Update frontend with UsersPage in admin area.

**Result:** SuperAdmin seeded via EF `HasData` in `UserConfiguration`. Registration always assigns `Role = "User"`. New `UsersController` (SuperAdmin-only) with `GetUsers` query and `AssignRole` command + validator. Category endpoints accept both Admin and SuperAdmin. Frontend updated: `AdminRoute` allows both roles, `UsersPage` with Make Admin / Revoke Admin buttons, routes added to `App.tsx`.
**Accepted/Changed:** Accepted as-is.

---

### Step 16 — Frontend refactor (Ant Design + Formik + shared infrastructure)
**Agent:** UI Developer (GitHub Copilot, Claude Opus 4.6)
**Prompt:**
> Analyse the UI part of the application. Remove code duplication, use ready-made elements from libraries, make types more generic. Full refactor with Ant Design, Formik, Yup, AuthContext, API service modules, shared types.

**Result:** Complete frontend rewrite. Replaced all inline-styled raw HTML (~983 lines, ~75 inline style objects) with Ant Design components. Key changes:
- **Shared types** (`src/types/models.ts`) — eliminated 3× duplicated `Category` interface
- **AuthContext** (`src/context/AuthContext.tsx`) — eliminated 3× duplicated JWT parsing (`getRole()`), centralized auth state
- **API service modules** (`src/api/authApi.ts`, `expenseApi.ts`, `categoryApi.ts`, `userApi.ts`) — eliminated raw `api.get/post/put/delete` calls scattered across every page
- **Merged LoginPage + RegisterPage** → single `AuthFormPage.tsx` with `mode` prop (were 95% identical)
- **Formik + Yup** for all forms with proper validation schemas
- **Ant Design** `Table`, `Menu`, `Layout`, `Card`, `Tag`, `Modal.confirm`, `message`, `ColorPicker`, `DatePicker`, `Select`, `InputNumber`, `Spin`, `Alert` replaced all manual tables, nav bars, sidebars, buttons, inputs, loading indicators, error messages, and browser `confirm()`/`alert()` dialogs
- Route guards (`ProtectedRoute`, `AdminRoute`) now use `useAuth()` hook
- Zero inline style objects remain

**Accepted/Changed:** Accepted as-is.

---

### Step 17 — Validation tests (Vitest + Testing Library)
**Agent:** Test Developer (GitHub Copilot, Claude Opus 4.6)
**Prompt:**
> Found couple most important places and add validation tests for them. Stack: Vitest (happy-dom), @testing-library/react, @testing-library/user-event, @testing-library/jest-dom. globals: true, BDD style, tests in `__tests__/` folders next to source. Also create new prompt file for test creation.

**Result:** Testing infrastructure set up and 30 validation tests created across 3 Yup schemas:
- **Installed** `vitest`, `happy-dom`, `@testing-library/react`, `@testing-library/user-event`, `@testing-library/jest-dom`
- **Configured** `vite.config.ts` with `test` section (globals, happy-dom, non-scoped CSS modules)
- **Exported** validation schemas from `AuthFormPage` (`loginSchema`, `registerSchema`), `ExpenseFormPage` (`expenseSchema`), `CategoryFormPage` (`categorySchema`)
- **AuthFormPage.test.ts** (12 tests) — email format/required, password required, min 8 chars for register, error messages
- **ExpenseFormPage.test.ts** (11 tests) — amount > 0, description required, date required, categoryId >= 1, error messages
- **CategoryFormPage.test.ts** (7 tests) — name required, hex color regex `#RRGGBB`, invalid formats, mixed case
- **Created** `.github/prompts/test-dev.prompt.md` — test agent instructions (load with `#test-dev`)

**Accepted/Changed:** Accepted as-is.

---

### Step 18 — Backend unit tests
**Agent:** Backend Test Developer (GitHub Copilot, Claude Opus 4.6)
**Prompt:**
> Create unit tests following our standard structure. Stack: xUnit, Moq, FluentAssertions, AutoFixture.Xunit2, FluentValidation.TestHelper. Mirror source folder structure. One test class per file. Separate Commands/ and Queries/ subfolders. Create tests for all handlers and validators. Also create prompt file for BE test and add to README.

**Result:** Full unit test project `ExpenseTracker.UnitTests` created with 110 tests across 20 test files:
- **8 handler test files** — RegisterCommandHandler, LoginQueryHandler, CreateCategory/UpdateCategory/DeleteCategory handlers, GetCategories query, CreateExpense/UpdateExpense/DeleteExpense handlers, GetExpenses/GetExpenseById queries, AssignRole handler, GetUsers query
- **8 validator test files** — RegisterCommand, LoginQuery, CreateCategory/UpdateCategory commands, CreateExpense/UpdateExpense commands, AssignRole command
- **Test project** — references Logic, Core, Api; global usings for Xunit & FluentAssertions
- **Created** `.github/prompts/backend-test.prompt.md` — backend test agent instructions (load with `#backend-test`)

All 110 tests pass.
**Accepted/Changed:** Accepted as-is.

---

### Step 19 — Server folder restructuring
**Agent:** Backend Developer (GitHub Copilot, Claude Opus 4.6)
**Prompt:**
> Change folder structure in server: shared/ for .editorconfig, src/ for all source projects, tests/ for test projects. Update documentation.

**Result:** Server folder restructured into three top-level directories:
- **shared/** — `.editorconfig`
- **src/** — `ExpenseTracker.Api`, `ExpenseTracker.Core`, `ExpenseTracker.Logic`, `ExpenseTracker.Persistence`
- **tests/** — `ExpenseTracker.UnitTests`
- Updated `.sln` project paths, `.csproj` project references (test→src), `copilot-instructions.md`, `backend-dev.prompt.md`, `backend-test.prompt.md`, `README.md`
- Build succeeded, all 109 tests pass.

**Accepted/Changed:** Accepted as-is.

---

### Step 21 — GET category by ID endpoint
**Agent:** GitHub Copilot
**Prompt:**
> Add a GET /api/categories/{id} endpoint.

**Result:** Created `GetCategoryByIdQuery` + `GetCategoryByIdQueryHandler` in Logic layer, added `GetById` action to `CategoriesController`, added 2 unit tests. Build and tests pass.
**Accepted/Changed:** Accepted as-is.

---

### Step 22 — Strict Monthly Income Enforcement
**Agent:** GitHub Copilot (backend-dev)
**Prompt:**
> Implement Strict Monthly Income Enforcement: IncomeCategory entity, Income CRUD (user-scoped), MonthlyBudget CRUD (user-scoped), constraint enforcement on expenses/budgets (total ≤ income), income modification guards (reject delete/reduce if would break budgets or expenses), zero-income rule (forbids budget and expense creation).

**Result:**
- **Core:** 3 new entities (IncomeCategory, Income, MonthlyBudget), 3 new repository interfaces, added `GetTotalForMonthAsync` to `IExpenseRepository`
- **Logic:** 15 CQRS operations (5 per new domain), modified `CreateExpenseCommandHandler` and `UpdateExpenseCommandHandler` with income constraint checks
- **Persistence:** 3 new EF configurations (with seed data for 4 income categories), 3 new repositories, modified `ExpenseRepository` and `AppDbContext`, generated migration
- **API:** 3 new controllers (`IncomeCategoriesController`, `IncomesController`, `BudgetsController`)
- **Tests:** 18 new test files, 5 modified test methods in existing expense tests. All 183 tests pass.
- **Docs:** Created `docs/implementation-steps-be.md`, added Financial Constraints section to `copilot-instructions.md`

**Accepted/Changed:** Accepted as-is.

---

## Insights

> *To be filled after project completion*

- Which prompts worked well?
- Which prompts did not work, and why?
- What patterns gave the best results?
